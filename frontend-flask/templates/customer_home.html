<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Home</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <!-- CSS from static folder -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/customer_home.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/animate.css') }}">
  
</head>

<body>
  <!-- Animated 3D Background Shapes -->
    <div class="bg-shape bg-shape1"></div>
    <div class="bg-shape bg-shape2"></div>
    <div class="bg-shape bg-shape3"></div>
    <div class="bg-cube"></div>

      <!-- Notification Pop-up -->
  <div id="notification-popup" style="display: none; position: fixed; top: 20px; right: 20px; background: #238915; color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 1000; max-width: 350px; animation: slideIn 0.3s;">
    <h3 id="alert-vendor" style="margin-bottom: 8px; font-size: 18px;"></h3>
    <p id="alert-message" style="margin: 4px 0; font-size: 14px;"></p>
    <p id="alert-items" style="margin: 4px 0; font-size: 13px; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 4px;"></p>
    <p id="alert-phone" style="margin-top: 8px; font-weight: bold;"><i class="fa-solid fa-phone"></i> <span id="phone-number"></span></p>
    <div style="display: flex; gap: 8px; margin-top: 12px;">
      <button onclick="dismissAlert()" style="flex: 1; padding: 8px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Dismiss</button>
      <button onclick="waitForVendor()" style="flex: 1; padding: 8px; background: white; color: #238915; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Wait</button>
    </div>
  </div>

  <style>
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>

  <!-- Top Bar with Customer Info -->
  <div class="topbar">    
    <div class="customer-info">
      <p class="name">{{ customer_name }}</p>
      <p><i class="fa-solid fa-phone"></i> {{ customer_phone }}</p>
      <p><i class="fa-solid fa-location-dot"></i> {{ customer_address }}</p>
    </div>

    <button class="back-btn" type="button" onclick="window.location.href='{{ url_for('logout') }}'">
      <i class="fa-solid fa-arrow-left"></i> LOGOUT
    </button>  

  </div>

  <!-- Main Container -->
  <div class="main-container">
    <div class="section-title">Available Vendors</div>

    <!-- Vendors List -->
    {% if vendors %}
      <div class="vendors-container">
        {% for vendor in vendors %}
          <div class="vendor-card">
            <div class="vendor-name">{{ vendor.name }}</div>
            <div class="vendor-detail">
              <i class="fa-solid fa-phone"></i>
              <span>{{ vendor.phone }}</span>
            </div>
            <div class="vendor-detail">
              <i class="fa-solid fa-location-dot"></i>
              <span>{{ vendor.city }}</span>
            </div>
            <div class="items">
              <strong>Items:</strong> 
              {% if vendor.vendor_items %}
                {{ vendor.vendor_items|join(', ') }}
              {% else %}
                No items
              {% endif %}
            </div>
            <button class="action-btn" onclick="contactVendor('{{ vendor.id }}', '{{ vendor.name }}')">
              <i class="fa-solid fa-envelope"></i> Contact
            </button>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="no-vendors">
        <i class="fa-solid fa-inbox"></i>
        <p>No vendors available at the moment</p>
        <p style="font-size: 14px; margin-top: 10px; color: #666;">Please check back later!</p>
      </div>
    {% endif %}
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    let currentAlertData = {};

    // WebSocket Connection - Register customer on connect
    const socket = io();
    const customerId = '{{ session.get("user_id") }}';
    
    socket.on('connect', function() {
      console.log('âœ“ Connected to server');
      if (customerId) {
        socket.emit('register_user', {user_id: customerId});
        console.log('âœ“ Customer registered:', customerId);
      }
    });
    
    // Listen for new alerts
    socket.on('new_alert', function(data) {
      console.log('âœ“ New alert received:', data);
      currentAlertData = data;
      showNotification(data);
    });
    
    function showNotification(data) {
      const popup = document.getElementById('notification-popup');
      document.getElementById('alert-vendor').textContent = data.vendor_name;
      document.getElementById('alert-message').textContent = `ðŸ“ ${data.locality}, ${data.city}`;
      
      // Handle vendor_items - could be array or string
      let itemsText = '';
      if (Array.isArray(data.vendor_items)) {
        itemsText = data.vendor_items.join(', ');
      } else if (data.vendor_items) {
        itemsText = data.vendor_items;
      } else {
        itemsText = 'No items';
      }
      document.getElementById('alert-items').textContent = `ðŸ“¦ Items: ${itemsText}`;
      document.getElementById('phone-number').textContent = data.vendor_phone;
      
      console.log('Alert data:', data);
      popup.style.display = 'block';
    }
    
    function dismissAlert() {
      const popup = document.getElementById('notification-popup');
      popup.style.display = 'none';
      
      fetch('/dismiss_alert', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          alert_id: currentAlertData.alert_id
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('âœ“ Alert dismissed:', data);
        alert('Alert dismissed successfully.');
      })
      .catch(error => console.error('Error dismissing alert:', error));
    }
    
    function waitForVendor() {
      const popup = document.getElementById('notification-popup');
      popup.style.display = 'none';
      
      console.log('Sending wait notification:', {
        alert_id: currentAlertData.alert_id,
        vendor_id: currentAlertData.vendor_id
      });
      
      fetch('/customer_wait', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          alert_id: currentAlertData.alert_id,
          vendor_id: currentAlertData.vendor_id
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ“ Vendor notified:', data);
        alert('Vendor has been notified! Please wait.');
      })
      .catch(error => console.error('Error notifying vendor:', error));
    }
    
    function closeNotification() {
      document.getElementById('notification-popup').style.display = 'none';
    }
    
    function viewAlerts() {
      window.location.href = '{{ url_for("get_alerts") }}';
    }
    
    function contactVendor(vendorId, vendorName) {
      alert('Contacting vendor: ' + vendorName);
    }
  </script>

</body>

</html>
