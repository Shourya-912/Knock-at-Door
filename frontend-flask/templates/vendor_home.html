<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vendor Home</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <!-- CSS from static folder -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/vendor_home.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/animate.css') }}">

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

</head>

<body>
    <!-- Animated 3D Background Shapes -->
    <div class="bg-shape bg-shape1"></div>
    <div class="bg-shape bg-shape2"></div>
    <div class="bg-shape bg-shape3"></div>
    <div class="bg-cube"></div>

    <!-- Top Navigation Bar -->
    <div class="topbar">
    <div class="topbar-left">
        <div class="vendor-info">
        <p class="name">{{ vendor_name }}</p>
        <p><i class="fa-solid fa-phone"></i> {{ vendor_phone }}</p>
        </div>
    </div>

    <div class="topbar-right">
        <!-- Locations Dropdown -->
        <div class="locations-dropdown">
        <button class="dropdown-btn" onclick="toggleDropdown()">
            <i class="fa-solid fa-map-marker-alt"></i> Locations
        </button>
        <div class="dropdown-menu" id="dropdown-menu">
            {% if locations %}
            {% for location in locations %}
                <div class="location-item">
                <span class="location-name">{{ location.locality }} - {{ location.area }}, {{ location.city }}</span>
                <!-- Locations Dropdown में हर location के लिए alert button -->
                <button class="alert-btn" onclick="sendAlert('{{ location.locality }}', '{{ location.area }}', '{{ location.city }}')">
                  <i class="fa-solid fa-bell"></i> Alert
                </button>
                </div>
            {% endfor %}
            {% else %}
            <div class="location-item">
                <span style="color: #999;">No locations added</span>
            </div>
            {% endif %}
        </div>
        </div>

        <!-- Logout Button -->
        <button class="logout-btn" type="button" onclick="window.location.href='{{ url_for('logout') }}'">
        LOGOUT </button>
    </div>
    </div>

    <!-- Customer Wait Popup Modal -->
    <div id="customer-wait-popup" style="display: none; position: fixed; top: 20px; right: 20px; background: #FF6B35; color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); z-index: 1000; max-width: 350px; animation: slideIn 0.3s;">
      <h3 id="customer-name-title" style="margin-bottom: 8px; font-size: 18px;"></h3>
      <p id="customer-phone-display" style="margin: 4px 0; font-size: 14px; font-weight: bold;"><i class="fa-solid fa-phone"></i> <span></span></p>
      <p id="customer-message" style="margin: 8px 0; font-size: 14px; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 4px;"></p>
      <div style="display: flex; gap: 8px; margin-top: 12px;">
        <button onclick="closeCustomerWaitPopup()" style="flex: 1; padding: 8px; background: white; color: #FF6B35; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">OK</button>
      </div>
    </div>

    <style>
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>

  <!-- Main Container -->
  <div class="main-container">
    <div class="section-title">My Items</div>

    <!-- Items List -->
    {% if items %}
      <div class="items-container">
        {% for item in items %}
          <div class="item-card">
            <div class="item-icon">
              <i class="fa-solid fa-box"></i>
            </div>
            <div class="item-name">{{ item.name }}</div>
            <div class="item-desc">Item Status: <strong>Active</strong></div>
            <button class="edit-btn" onclick="editItem('{{ item.id }}')">
              <i class="fa-solid fa-edit"></i> Edit
            </button>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="no-items">
        <i class="fa-solid fa-inbox"></i>
        <p>No items uploaded yet</p>
        <p style="font-size: 14px; color: #666; margin-bottom: 20px;">Start by adding your first item</p>
        <button class="add-item-btn" onclick="window.location.href='{{ url_for('vendor_reg') }}'">
          <i class="fa-solid fa-plus"></i> Add Item
        </button>
      </div>
    {% endif %}
  </div>

  <script>
    function toggleDropdown() {
      const dropdown = document.getElementById('dropdown-menu');
      dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('dropdown-menu');
      const dropdownBtn = document.querySelector('.dropdown-btn');
      if (!event.target.closest('.locations-dropdown')) {
        dropdown.classList.remove('show');
      }
    });

    function editItem(itemId) {
      alert('Edit item: ' + itemId);
    }

    // WebSocket for vendor wait notifications
    const socket = io();
    
    socket.on('connect', function() {
      console.log('✓ Vendor connected');
      const vendorId = '{{ session.get("user_id") }}';
      if (vendorId) {
        socket.emit('register_user', {user_id: vendorId});
        console.log('✓ Vendor registered:', vendorId);
      }
    });
    
    socket.on('customer_wait', function(data) {
      console.log('✓ Customer wait notification:', data);
      showCustomerWaitPopup(data);
    });
    
    function showCustomerWaitPopup(data) {
      const popup = document.getElementById('customer-wait-popup');
      document.getElementById('customer-name-title').textContent = `⏰ ${data.customer_name}`;
      document.getElementById('customer-phone-display').innerHTML = `<i class="fa-solid fa-phone"></i> <span>${data.customer_phone}</span>`;
      document.getElementById('customer-message').textContent = data.message;
      
      popup.style.display = 'block';
      playNotificationSound();
    }
    
    function closeCustomerWaitPopup() {
      document.getElementById('customer-wait-popup').style.display = 'none';
    }
    
    
    function playNotificationSound() {
      // Simple beep using Web Audio API
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch(e) {
        console.log('Could not play sound:', e);
      }
    }

    function sendAlert(locality, area, city) {
      const formData = new FormData();
      formData.append('locality', locality);
      formData.append('area', area);
      formData.append('city', city);
      
      fetch('/send_alert', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
        console.log(data);
      })
      .catch(error => console.error('Error:', error));
    }

  </script>

</body>

</html>
